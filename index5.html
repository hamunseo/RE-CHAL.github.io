<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>디자인 가이드 카드 제출</title>
  <link rel="stylesheet" href="style5.css" />
</head>
<body>
  <div class="container">
    <!-- 헤더 -->
    <div class="nav-bar">
      <img src="image/logo.png" alt="로고" class="logo">
      <ul class="menu">
        <li><a href="#">챌린지</a></li>
        <li><a href="#">라이브러리</a></li>
        <li><a href="#">프로필페이지</a></li>
      </ul>
    </div>

    <!-- 메인 콘텐츠 -->
    <div class="innerbox">
      <!-- 왼쪽: 선택된 가이드 카드 미리보기 -->
      <div class="guide-preview">
        <h2>디자인 가이드 카드</h2>
        <div class="cardbox" id="preview-card">
          <!-- JS로 여기에 index4에서 선택한 카드 내용이 주입됩니다 -->
        </div>
      </div>

      <!-- 오른쪽: 업로드 & 설명 -->
      <div class="submit-zone">
        <div class="image-upload">
          <div class="description">
            <h3>이미지 업로드</h3>
            <p>해당 과제를 해결할 시각적 결과물을 업로드 하세요.</p>
          </div>
          <div class="upload-dropzone" id="dropzone">
            <span class="placeholder">
              클릭 또는 드래그하여<br>이미지를 선택하세요
            </span>
            <input type="file" id="fileInput" accept="image/*" multiple />
          </div>
        </div>
        <div class="task-desc">
          <div class="description">
            <h3>과제 설명</h3>
            <p>해당 과제를 해결하게 된 과정을 작성하세요.</p>
          </div>
          <textarea id="description" placeholder="해당 과제를 해결하게 된 과정에 대한 설명을 작성하세요."></textarea>
        </div>
      </div>
    </div>

    <div class="floating-nav">
      <button class="prev-btn">← 이전으로</button>
      <button class="next-btn">제출하기</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp }            from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getFirestore, collection, addDoc, doc, getDoc } 
      from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

    // 1) Firebase 초기화
    const firebaseConfig = {
      apiKey: "AIzaSyD8C0r8KaBck2olZ-6lab7nr3pV3sHtlNM",
      authDomain: "design-cha.firebaseapp.com",
      projectId: "design-cha",
      storageBucket: "design-cha.appspot.com",
      messagingSenderId: "880464166610",
      appId: "1:880464166610:web:85a490dced53ed0e31370b"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // 2) URL에서 파라미터(id, sourceId) 꺼내기
    const params       = new URLSearchParams(window.location.search);
    const selectedId   = params.get('id');        // selectedCards 문서 ID
    const cardSourceId = params.get('sourceId');  // generatedCards 문서 ID

    // 3) 미리보기 렌더링
    async function renderPreview() {
      const preview = document.getElementById('preview-card');
      if (!selectedId) {
        preview.textContent = '불러올 카드가 없습니다.';
        return;
      }
      const snap = await getDoc(doc(db, 'selectedCards', selectedId));
      if (!snap.exists()) {
        preview.textContent = '카드를 찾을 수 없습니다.';
        return;
      }
      const card = snap.data();

      preview.innerHTML = `
        <div class="task-bubble fixed">
          <div class="card-back">
            <div class="tag">#${card.분류}</div>
            <h2>${card.과제제목}</h2>
            <div class="border"></div>
            <div class="detail-group">
              <div class="box"><h4>문제점</h4><p>${card.문제점}</p></div>
              <div class="box"><h4>사용자니즈</h4><p>${card.사용자니즈}</p></div>
              <div class="box"><h4>해결전략</h4><p>${card.UX해결전략1}</p></div>
              <div class="box"><h4>추천 UI</h4><p>${card.UX해결전략1_추천UI}</p></div>
              <div class="box"><h4>참고사례</h4><p>${card.UX해결전략1_참고사례}</p></div>
            </div>
          </div>
        </div>`;
    }

    // 4) 다중 이미지 업로드 & 미리보기 (Base64)
    const dropzone    = document.getElementById('dropzone');
    const fileInput   = document.getElementById('fileInput');
    const placeholder = dropzone.querySelector('.placeholder');

    ['dragenter','dragover'].forEach(evt =>
      dropzone.addEventListener(evt, e => {
        e.preventDefault();
        dropzone.classList.add('dragover');
      })
    );
    ['dragleave','drop'].forEach(evt =>
      dropzone.addEventListener(evt, e => {
        e.preventDefault();
        dropzone.classList.remove('dragover');
      })
    );

    dropzone.addEventListener('click', () => fileInput.click());
    dropzone.addEventListener('drop', e => {
      fileInput.files = e.dataTransfer.files;
      handleFiles();
    });
    fileInput.addEventListener('change', handleFiles);

    function handleFiles() {
      const files = Array.from(fileInput.files);
      dropzone.querySelectorAll('img.preview').forEach(img => img.remove());
      placeholder.style.display = 'none';

      files.forEach(file => {
        if (!file.type.startsWith('image/')) return;
        const reader = new FileReader();
        reader.onload = e => {
          const img = document.createElement('img');
          img.className = 'preview';
          img.src = e.target.result;
          dropzone.appendChild(img);
        };
        reader.readAsDataURL(file);
      });
    }

    // 5) 제출하기 & 이전으로
    document.querySelector('.prev-btn').addEventListener('click', () => {
      // 뒤로 가면 index4 에 selectedId와 sourceId 유지
      window.location.href = `index4.html?id=${selectedId}&sourceId=${cardSourceId}`;
    });
    document.querySelector('.next-btn').addEventListener('click', submitSolution);

    async function submitSolution() {
      if (!selectedId || !cardSourceId) {
        return alert('카드를 불러오지 못했습니다. 다시 시도해 주세요.');
      }
      const btn = document.querySelector('.next-btn');
      btn.disabled    = true;
      btn.textContent = '저장 중…';

      try {
        // 과제 설명
        const description = document.getElementById('description').value.trim();

        // 이미지 Base64
        const files  = Array.from(fileInput.files);
        const images = await Promise.all(files.map(file =>
          new Promise(resolve => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.readAsDataURL(file);
          })
        ));

        // Firestore 저장
        const docRef = await addDoc(
          collection(db, 'submissions'),
          {
            cardId:         selectedId,
            cardSourceId:   cardSourceId,
            description:    description,
            imageUrls:      images,
            createdAt:      new Date()
          }
        );

        // index6 로 이동
        window.location.href = `index6.html?id=${docRef.id}`;
      } catch (err) {
        console.error(err);
        alert('저장 중 오류가 발생했습니다.');
        btn.disabled    = false;
        btn.textContent = '제출하기';
      }
    }

    window.addEventListener('DOMContentLoaded', renderPreview);
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>제출 내역 확인</title>
  <link rel="stylesheet" href="style6.css" />
</head>
<body>
  <div class="container">
    <!-- 헤더 -->
    <div class="nav-bar">
      <img src="image/logo.png" alt="로고" class="logo">
      <ul class="menu">
        <li><a href="#">챌린지</a></li>
        <li><a href="#">라이브러리</a></li>
        <li><a href="#">프로필페이지</a></li>
      </ul>
    </div>

    <!-- 메인 콘텐츠 -->
    <div class="innerbox">
      <!-- 왼쪽: 디자인 가이드 카드-->
      <div class="guide-preview">
        <h2>디자인 가이드 카드</h2>
        <div class="cardbox" id="preview-card">
          <!-- 가이드카드 렌더링 -->
        </div>
      </div>

      <!-- 오른쪽: 제출된 이미지 & 설명 확인 -->
      <div class="submit-zone">
        <h2>제출 내역</h2>
        <div class="images" id="submitted-images">
          <!-- JS로 이미지 여러 장 렌더링 -->
        </div>
        <div class="submitted-description">
          <h3>과제 설명</h3>
          <p id="submitted-text"></p>
        </div>
      </div>
    </div>

    <div class="floating-nav">
      <button class="prev-btn">← 이전으로</button>
      <button class="edit-btn">수정하기</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

    // Firebase 초기화
    const firebaseConfig = {
      apiKey: "AIzaSyD8C0r8KaBck2olZ-6lab7nr3pV3sHtlNM",
      authDomain: "design-cha.firebaseapp.com",
      projectId: "design-cha",
      storageBucket: "design-cha.appspot.com",
      messagingSenderId: "880464166610",
      appId: "1:880464166610:web:19ef-46c7-bed0-969f06f57594"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // URL에서 submissionId 꺼내기
    const params       = new URLSearchParams(window.location.search);
    const submissionId = params.get('id');

    // “이전으로” 버튼: 무조건 index3.html 로
    document.querySelector('.prev-btn').addEventListener('click', () => {
      window.location.href = 'index3.html';
    });

    // 전체 렌더링
    async function renderAll() {
      if (!submissionId) {
        alert('불러올 제출 내역이 없습니다.');
        return;
      }

      // 1) submissions에서 가져오기
      const subSnap = await getDoc(doc(db, 'submissions', submissionId));
      if (!subSnap.exists()) {
        document.getElementById('submitted-text').textContent = '제출 문서를 찾을 수 없습니다.';
        return;
      }
      const sub = subSnap.data();

      // 2) selectedCards에서 가이드카드 가져오기
      const cardSnap = await getDoc(doc(db, 'selectedCards', sub.cardId));
      const preview  = document.getElementById('preview-card');
      if (cardSnap.exists()) {
        const card = cardSnap.data();
        preview.innerHTML = `
          <div class="task-bubble fixed">
            <div class="card-back">
              <div class="tag">#${card.분류}</div>
              <h2>${card.과제제목}</h2>
              <div class="border"></div>
              <div class="detail-group">
                <div class="box"><h4>문제점</h4><p>${card.문제점}</p></div>
                <div class="box"><h4>사용자니즈</h4><p>${card.사용자니즈}</p></div>
                <div class="box"><h4>해결전략</h4><p>${card.UX해결전략1}</p></div>
                <div class="box"><h4>추천 UI</h4><p>${card.UX해결전략1_추천UI}</p></div>
                <div class="box"><h4>참고사례</h4><p>${card.UX해결전략1_참고사례}</p></div>
              </div>
            </div>
          </div>`;
      } else {
        preview.textContent = '연결된 가이드 카드를 불러올 수 없습니다.';
      }

      // 3) 이미지 갤러리 렌더링 (imageUrls 배열)
      const imagesContainer = document.getElementById('submitted-images');
      imagesContainer.innerHTML = '';
      const imgList = Array.isArray(sub.imageUrls) ? sub.imageUrls : [];
      if (imgList.length) {
        imgList.forEach(src => {
          const img = document.createElement('img');
          img.src       = src;
          img.className = 'submitted-img';
          imagesContainer.appendChild(img);
        });
      } else {
        imagesContainer.textContent = '제출된 이미지가 없습니다.';
      }

      // 4) 설명 렌더링
      document.getElementById('submitted-text').textContent =
        sub.description || '제출된 설명이 없습니다.';

      // 5) “수정하기” 버튼: index5로, cardId 와 cardSourceId 함께 전달
      const editBtn = document.querySelector('.edit-btn');
      editBtn.addEventListener('click', () => {
        window.location.href =
          `index5.html?id=${sub.cardId}&sourceId=${sub.cardSourceId}`;
      });
    }

    window.addEventListener('DOMContentLoaded', renderAll);
  </script>
</body>
</html>
